<!doctype html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Arc Raiders: Text-Koop</title>
  <style>
    :root {
      --bg: #0f1116;
      --panel: #171b24;
      --accent: #9ef0ff;
      --accent-2: #f5d76e;
      --text: #f0f3ff;
      --muted: #97a0b5;
      --danger: #ff6b6b;
      --success: #9be15d;
      --border: #2a3142;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(158,240,255,0.08), transparent 25%),
                  radial-gradient(circle at 80% 0%, rgba(245,215,110,0.08), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    header {
      padding: 24px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(135deg, rgba(158,240,255,0.08), rgba(15,17,22,0.8));
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }
    h1 { margin: 0; letter-spacing: 0.04em; }
    .subline { color: var(--muted); margin: 0; }
    main { padding: 24px; display: grid; gap: 16px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }
    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 14px 40px rgba(0,0,0,0.35);
    }
    .panel h2 { margin-top: 0; font-size: 1rem; letter-spacing: 0.03em; text-transform: uppercase; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 12px; }
    .stack { display: flex; flex-direction: column; gap: 8px; }
    label { display: block; font-size: 0.9rem; color: var(--muted); margin-bottom: 4px; }
    input, select, button, textarea {
      width: 100%;
      background: #0f131a;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      color: var(--text);
      font-size: 0.95rem;
    }
    button {
      background: linear-gradient(135deg, rgba(158,240,255,0.16), rgba(158,240,255,0.08));
      cursor: pointer;
      transition: transform 0.08s ease, border-color 0.2s ease, background 0.2s ease;
      border-color: rgba(158,240,255,0.3);
    }
    button:hover { transform: translateY(-1px); border-color: var(--accent); }
    button.secondary { background: linear-gradient(135deg, rgba(245,215,110,0.16), rgba(245,215,110,0.05)); border-color: rgba(245,215,110,0.2); }
    button.danger { background: rgba(255,107,107,0.08); border-color: rgba(255,107,107,0.3); }
    ul { list-style: none; padding: 0; margin: 0; }
    .tag { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border); color: var(--muted); }
    .badge { background: rgba(155,225,93,0.12); color: var(--success); border-color: rgba(155,225,93,0.35); }
    .box {
      border: 1px dashed var(--border);
      border-radius: 10px;
      padding: 12px;
      min-height: 60px;
      background: rgba(255,255,255,0.02);
    }
    .row { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .pill { padding: 4px 10px; border-radius: 999px; background: rgba(158,240,255,0.1); color: var(--accent); border: 1px solid rgba(158,240,255,0.2); font-size: 0.8rem; }
    .muted { color: var(--muted); }
    .log { max-height: 320px; overflow-y: auto; background: #0d0f14; border: 1px solid var(--border); border-radius: 10px; padding: 12px; display: flex; flex-direction: column; gap: 8px; }
    .log-entry { border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 6px; }
    .log-entry:last-child { border-bottom: none; }
    .stat-line { display: flex; gap: 8px; flex-wrap: wrap; }
    .card {
      padding: 12px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: rgba(255,255,255,0.02);
    }
    .threat-tier-1 { border-color: rgba(155,225,93,0.35); }
    .threat-tier-2 { border-color: rgba(245,215,110,0.4); }
    .threat-tier-3 { border-color: rgba(255,138,101,0.4); }
    .threat-tier-4 { border-color: rgba(255,107,107,0.8); }
    .small { font-size: 0.85rem; }
    .section-title { font-weight: 700; letter-spacing: 0.03em; }
    .inline-buttons { display: flex; gap: 8px; flex-wrap: wrap; }
    .loot-legendary { color: #f19bff; }
    .loot-epic { color: #9ef0ff; }
    .loot-rare { color: #7ae0a3; }
    .loot-common { color: #d0d7e3; }
    .danger-text { color: var(--danger); }
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Arc Raiders – Textbasierte Koop-Raid</h1>
      <p class="subline">Scoute Bedrohungen, halte Moral hoch, sichere Loot. Rein im Browser, kooperativ spielbar.</p>
    </div>
    <div class="row">
      <span class="pill">Inspiration: Arc Raiders</span>
      <span class="pill">Koop / Text</span>
      <span class="pill" id="session-pill">Session: neu</span>
    </div>
  </header>

  <main>
    <section class="panel">
      <h2>LAN-Sync</h2>
      <div class="grid">
        <div class="stack">
          <label for="lanEndpoint">Server-Adresse (LAN)</label>
          <input id="lanEndpoint" placeholder="http://192.168.0.23:8000/api/session" />
        </div>
        <div class="stack">
          <label>Status</label>
          <div class="box" id="lanStatus">Offline – Browser-Only</div>
        </div>
      </div>
      <div class="inline-buttons" style="margin-top: 10px;">
        <button id="lanToggleBtn">LAN-Sync aktivieren</button>
        <button id="lanSyncNowBtn" class="secondary">Jetzt synchronisieren</button>
      </div>
      <p class="muted small" style="margin-top: 8px;">LAN-Modus tauscht den Raid-Status alle paar Sekunden mit dem Python-Server aus – perfekt für Koop im selben Netz.</p>
    </section>

    <section class="panel">
      <h2>Session & Synchronisation</h2>
      <div class="grid">
        <div class="stack">
          <label for="sessionName">Session-Name</label>
          <input id="sessionName" placeholder="z. B. Nord-Front" />
        </div>
        <div class="stack">
          <label for="sessionLoad">Session-Link einfügen</label>
          <input id="sessionLoad" placeholder="Link oder Code einfügen" />
        </div>
      </div>
      <div class="inline-buttons" style="margin-top: 12px;">
        <button id="quickMatchBtn" class="secondary">Spiel suchen (Auto-Session)</button>
        <button id="newSessionBtn">Neue Session</button>
        <button id="copyLinkBtn" class="secondary">Status teilen (Link kopieren)</button>
        <button id="loadSessionBtn" class="secondary">Session laden</button>
        <button id="clearStateBtn" class="danger">Reset (lokal)</button>
      </div>
      <p id="matchmakingStatus" class="muted small" style="margin-top: 8px;">Spielsuche startet automatisch eine Session mit Arc-Raid-Ziel.</p>
      <p class="muted small" style="margin-top: 8px;">Synchronisation live für Tabs/Fenster derselben Domain via BroadcastChannel. Für asynchrones Spielen Link teilen.</p>
    </section>

    <section class="panel">
      <h2>Squad – Widerstandszelle</h2>
      <div class="grid">
        <div class="stack">
          <label>Name</label>
          <input id="playerName" placeholder="Callsign" />
        </div>
        <div class="stack">
          <label>Rolle</label>
          <select id="playerRole">
            <option>Späher</option>
            <option>Hacker</option>
            <option>Medic</option>
            <option>Schütze</option>
          </select>
        </div>
        <div class="stack">
          <label>Ausrüstung</label>
          <input id="playerGear" placeholder="z. B. Signal Flare, EMP" />
        </div>
      </div>
      <div class="inline-buttons" style="margin-top: 10px;">
        <button id="addPlayerBtn">Zum Squad hinzufügen</button>
        <button id="scoutWeakBtn" class="secondary">Schwachstelle scouten</button>
      </div>
      <div class="grid" id="squadList" style="margin-top: 12px;"></div>
    </section>

    <section class="panel">
      <h2>Bedrohungen</h2>
      <div class="inline-buttons" style="margin-bottom: 10px;">
        <button id="drawThreatBtn">Bedrohung ziehen</button>
        <button id="advanceThreatBtn" class="secondary">Druck erhöhen</button>
        <button id="resolveThreatBtn" class="secondary">Bedrohung entschärfen</button>
      </div>
      <div class="grid" id="threatBoard"></div>
    </section>

    <section class="panel">
      <h2>Aktionen</h2>
      <div class="inline-buttons" style="margin-bottom: 10px;">
        <button data-action="scout">Scout</button>
        <button data-action="suppress">Unterdrücken</button>
        <button data-action="hack">Hack</button>
        <button data-action="heal">Versorgung</button>
        <button data-action="loot">Loot-Kiste öffnen</button>
      </div>
      <div class="grid">
        <div class="box" id="actionResult">Ergebnis-Log erscheint hier.</div>
        <div class="box">
          <div class="section-title">Squad-Status</div>
          <div class="stat-line small">
            <span class="tag">Moral: <strong id="moraleValue">100</strong></span>
            <span class="tag">Supplies: <strong id="supplyValue">4</strong></span>
            <span class="tag">Bedrohungsdruck: <strong id="pressureValue">0</strong></span>
          </div>
          <p class="muted small" id="squadHint">Halte Moral hoch, um Loot-Boni zu erhalten.</p>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Loot & Funde</h2>
      <div class="grid">
        <div>
          <div class="section-title">Aktueller Drop</div>
          <div class="box" id="lootBox">Noch keine Kiste geöffnet.</div>
        </div>
        <div>
          <div class="section-title">Loot-Log</div>
          <div class="log" id="lootLog"></div>
        </div>
      </div>
    </section>

    <section class="panel">
      <h2>Operations-Log</h2>
      <div class="log" id="opLog"></div>
    </section>
  </main>

  <script>
    const channel = new BroadcastChannel('arc-raiders-raid');
    const storageKey = 'arc-raiders-session';

    const lootTable = [
      { rarity: 'Legendär', name: 'Meteor Core', bonus: '+2 Hack & Unterdrücken', className: 'loot-legendary' },
      { rarity: 'Legendär', name: 'Arc Spire-Kern', bonus: '+3 Hack, +2 Scout', className: 'loot-legendary' },
      { rarity: 'Episch', name: 'VFX-Arc Bow', bonus: '+2 Scout & Moral', className: 'loot-epic' },
      { rarity: 'Episch', name: 'Signal Jammer', bonus: '+2 Hack', className: 'loot-epic' },
      { rarity: 'Selten', name: 'Rail Core Ammo', bonus: '+1 Unterdrücken', className: 'loot-rare' },
      { rarity: 'Selten', name: 'Thermal Scope', bonus: '+1 Scout', className: 'loot-rare' },
      { rarity: 'Selten', name: 'Reclaimer Drone', bonus: '+1 Hack & Supplies', className: 'loot-rare' },
      { rarity: 'Gewöhnlich', name: 'Medkit', bonus: '+1 Versorgung', className: 'loot-common' },
      { rarity: 'Gewöhnlich', name: 'Batteriepack', bonus: '+1 Hack', className: 'loot-common' },
    ];

    const threatDeck = [
      { name: 'Patrouillen-Drohnen', tier: 1, effect: 'Spähen erschwert, Druck +1' },
      { name: 'Signal Jam', tier: 2, effect: 'Hack erschwert, Moral -5' },
      { name: 'Belagerungs-Walker', tier: 3, effect: 'Unterdrücken nötig, Druck +2' },
      { name: 'Arc Titan', tier: 4, effect: 'Großangriff, Moral -10' },
      { name: 'Störfeuer', tier: 2, effect: 'Scout Abzüge, Supplies -1' },
      { name: 'EMP-Minefield', tier: 3, effect: 'Hack & Scout erschwert, Druck +1' },
      { name: 'Orbitaler Suchschein', tier: 2, effect: 'Sicht offenbart Squad, Druck +1' },
      { name: 'Kettenhund-Drohnen', tier: 1, effect: 'Nahkampfbedrohung, Moral -3' },
      { name: 'Arc Spire-Laser', tier: 3, effect: 'Orbitalschlag lädt, Druck +2' },
      { name: 'Raider Drop Pod', tier: 2, effect: 'Frische Arcs landen, Moral -4' },
      { name: 'Hunter-Seeker Schwarm', tier: 4, effect: 'Jagd auf Signalquellen, Druck +3' },
    ];

    const baseState = () => ({
      sessionId: crypto.randomUUID(),
      name: 'Unbenannt',
      morale: 100,
      supplies: 4,
      pressure: 0,
      players: [],
      threats: [],
      log: [],
      lootLog: [],
      updatedAt: Date.now(),
    });

    let state = loadState();
    render();

    let lanSyncEnabled = false;
    let lanEndpoint = `${location.origin}/api/session`;
    const lanStatus = document.getElementById('lanStatus');
    const lanToggleBtn = document.getElementById('lanToggleBtn');
    const quickMatchBtn = document.getElementById('quickMatchBtn');
    const matchmakingStatus = document.getElementById('matchmakingStatus');

    document.getElementById('lanEndpoint').value = lanEndpoint;

    channel.onmessage = (event) => {
      if (event.data?.type === 'sync' && event.data.sessionId === state.sessionId) {
        state = event.data.payload;
        render(true);
      }
    };

    document.querySelectorAll('[data-action]').forEach(btn => btn.addEventListener('click', () => performAction(btn.dataset.action)));
    document.getElementById('addPlayerBtn').addEventListener('click', addPlayer);
    document.getElementById('drawThreatBtn').addEventListener('click', drawThreat);
    document.getElementById('advanceThreatBtn').addEventListener('click', () => adjustPressure(1, 'Bedrohungsdruck steigt.'));
    document.getElementById('resolveThreatBtn').addEventListener('click', resolveThreat);
    document.getElementById('newSessionBtn').addEventListener('click', newSession);
    document.getElementById('quickMatchBtn').addEventListener('click', startQuickMatch);
    document.getElementById('copyLinkBtn').addEventListener('click', copyShareLink);
    document.getElementById('loadSessionBtn').addEventListener('click', loadFromLinkField);
    document.getElementById('clearStateBtn').addEventListener('click', resetLocal);
    document.getElementById('scoutWeakBtn').addEventListener('click', () => performAction('scout'));
    document.getElementById('lanToggleBtn').addEventListener('click', toggleLanSync);
    document.getElementById('lanSyncNowBtn').addEventListener('click', syncNow);

    function loadState() {
      const stored = localStorage.getItem(storageKey);
      if (!stored) return baseState();
      try {
        return JSON.parse(stored);
      } catch (e) {
        console.warn('Konnte lokalen State nicht laden', e);
        return baseState();
      }
    }

    function persist(broadcast = true) {
      state.updatedAt = Date.now();
      localStorage.setItem(storageKey, JSON.stringify(state));
      if (broadcast) channel.postMessage({ type: 'sync', sessionId: state.sessionId, payload: state });
      if (lanSyncEnabled) pushStateToServer();
    }

    function newSession(nameOverride, options = {}) {
      const nameField = document.getElementById('sessionName');
      const newName = (nameOverride ?? nameField.value.trim()) || 'Widerstand';
      state = baseState();
      state.name = newName;
      if (options.skipLog !== true) {
        logEvent(`Neue Session gestartet: ${newName}`);
      }
      render();
      persist();
    }

    function generateAutoSessionName() {
      const operations = ['Vanguard', 'Echo', 'Spear', 'Pulsar', 'Nova', 'Relay', 'Bastion'];
      const locations = ['Schlucht', 'Waldlichtung', 'Funkposten', 'Satellit', 'Spire', 'Damm', 'Refugium'];
      const numbers = Math.floor(Math.random() * 900 + 100);
      return `${operations[Math.floor(Math.random() * operations.length)]}-${numbers} @ ${locations[Math.floor(Math.random() * locations.length)]}`;
    }

    function startQuickMatch() {
      const name = generateAutoSessionName();
      matchmakingStatus.textContent = 'Suche nach Arc-Überfall ...';
      quickMatchBtn.disabled = true;
      quickMatchBtn.textContent = 'Suche ...';

      setTimeout(() => {
        newSession(name, { skipLog: true });
        logEvent(`Spiel gefunden: ${name} – Squad droppt.`);
        logEvent('Arc-Funk bricht durch: Erste Bedrohungen werden markiert.');
        drawThreat();
        logEvent('Runde läuft: Sammle Loot, halte Moral, sichere den Evac.');
        render();
        persist();
        matchmakingStatus.textContent = `Session aktiv – ${name}`;
        quickMatchBtn.disabled = false;
        quickMatchBtn.textContent = 'Spiel suchen (Auto-Session)';
      }, 800);
    }

    function addPlayer() {
      const name = document.getElementById('playerName').value.trim();
      const role = document.getElementById('playerRole').value;
      const gear = document.getElementById('playerGear').value.trim();
      if (!name) return;
      state.players.push({ id: crypto.randomUUID(), name, role, gear, status: 'Aktiv' });
      logEvent(`${name} (${role}) schließt sich an. Ausrüstung: ${gear || 'Standard'}.`);
      render();
      persist();
      document.getElementById('playerName').value = '';
      document.getElementById('playerGear').value = '';
    }

    function render(skipPersist = false) {
      document.getElementById('session-pill').textContent = `Session: ${state.name}`;
      document.getElementById('moraleValue').textContent = state.morale;
      document.getElementById('supplyValue').textContent = state.supplies;
      document.getElementById('pressureValue').textContent = state.pressure;
      document.getElementById('sessionName').value = state.name;
      renderSquad();
      renderThreats();
      renderLogs();
      document.getElementById('squadHint').textContent = hint();
      if (!skipPersist) persist(false);
    }

    function renderSquad() {
      const container = document.getElementById('squadList');
      container.innerHTML = '';
      if (!state.players.length) {
        container.innerHTML = '<p class="muted">Noch keine Operativen im Squad.</p>';
        return;
      }
      state.players.forEach(p => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `<div class="stat-line"><strong>${p.name}</strong><span class="tag">${p.role}</span></div>
          <p class="muted small">${p.gear || 'Standard-Kit'} – Einsatzbereit gegen Arcs</p>
          <div class="stat-line small"><span class="tag badge">${p.status}</span></div>`;
        container.appendChild(card);
      });
    }

    function renderThreats() {
      const container = document.getElementById('threatBoard');
      container.innerHTML = '';
      if (!state.threats.length) {
        container.innerHTML = '<p class="muted">Bedrohungsboard leer. Ziehe eine Karte.</p>';
        return;
      }
      state.threats.slice(0, 4).forEach(t => {
        const card = document.createElement('div');
        card.className = `card threat-tier-${t.tier}`;
        card.innerHTML = `<div class="stat-line"><strong>${t.name}</strong><span class="tag">Stufe ${t.tier}</span></div>
          <p class="muted small">${t.effect}</p>
          <p class="small">Status: ${t.status || 'Aktiv'} | Schwachstelle: ${t.weakness || 'keine'}</p>`;
        container.appendChild(card);
      });
    }

    function renderLogs() {
      const opLog = document.getElementById('opLog');
      opLog.innerHTML = state.log.slice(-20).map(entry => `<div class="log-entry small">${entry}</div>`).join('');
      const lootLog = document.getElementById('lootLog');
      lootLog.innerHTML = state.lootLog.slice(-12).map(entry => `<div class="log-entry small">${entry}</div>`).join('');
    }

    function drawThreat() {
      const threat = structuredClone(threatDeck[Math.floor(Math.random() * threatDeck.length)]);
      threat.id = crypto.randomUUID();
      threat.status = 'Aktiv';
      threat.weakness = ['EMP', 'Schwachpunkt', 'Tarnung', 'Störsender'][Math.floor(Math.random() * 4)];
      state.threats.unshift(threat);
      adjustPressure(threat.tier - 1, `${threat.name} erscheint. Druck steigt.`);
      logEvent(`Neue Bedrohung: ${threat.name} (Stufe ${threat.tier}). Arc-Signatur verstärkt.`);
      render();
    }

    function resolveThreat() {
      if (!state.threats.length) return;
      const resolved = state.threats.shift();
      const reward = Math.max(1, resolved.tier - 1);
      state.supplies = Math.min(8, state.supplies + reward);
      state.pressure = Math.max(0, state.pressure - resolved.tier);
      logEvent(`${resolved.name} neutralisiert. Supplies +${reward}, Druck -${resolved.tier}.`);
      render();
    }

    function adjustPressure(delta, reason) {
      state.pressure = Math.max(0, state.pressure + delta);
      if (reason) logEvent(reason);
      if (state.pressure > 8) {
        state.morale = Math.max(0, state.morale - 5);
        logEvent('Überdruck! Moral sinkt um 5.');
      }
      render();
    }

    function performAction(type) {
      const player = randomPlayer();
      const bonus = lootBonus(type);
      const pressurePenalty = Math.max(0, state.pressure - 4);
      const supplyBonus = type === 'heal' ? state.supplies * 0.5 : 0;
      const moraleModifier = state.morale >= 80 ? 5 : 0;
      const roll = Math.floor(Math.random() * 100) + 1;
      const total = roll + bonus - pressurePenalty + supplyBonus + moraleModifier;
      let result = '';

      switch (type) {
        case 'scout':
          if (total >= 60) {
            const hintText = revealWeakness();
            state.morale = Math.min(120, state.morale + 5);
            result = `Erfolg (${total}). Schwachstelle entdeckt: ${hintText}. Moral +5.`;
          } else {
            state.pressure += 1;
            result = `Fehlschlag (${total}). Patrol entdeckt das Squad. Druck +1.`;
          }
          break;
        case 'suppress':
          if (total >= 65) {
            state.pressure = Math.max(0, state.pressure - 2);
            result = `Unterdrückungsfeuer sitzt (${total}). Druck -2.`;
          } else {
            state.morale = Math.max(0, state.morale - 5);
            result = `Zu wenig Feuer (${total}). Moral -5.`;
          }
          break;
        case 'hack':
          if (total >= 70) {
            const cache = grantLoot('Selten oder besser');
            state.pressure = Math.max(0, state.pressure - 1);
            result = `Hack erfolgreich (${total}). Arc-Netzwerk angezapft: ${cache}. Druck -1.`;
          } else {
            state.supplies = Math.max(0, state.supplies - 1);
            result = `Hack gescheitert (${total}). Supplies -1.`;
          }
          break;
        case 'heal':
          if (total >= 55) {
            state.morale = Math.min(120, state.morale + 8);
            state.supplies = Math.max(0, state.supplies - 1);
            result = `Versorgung stabil (${total}). Moral +8, Supplies -1.`;
          } else {
            result = `Medbay überlastet (${total}). Keine Wirkung.`;
          }
          break;
        case 'loot':
          const drop = grantLoot();
          state.supplies = Math.max(0, state.supplies - 1);
          result = `Loot erhalten: ${drop}. Supplies -1.`;
          break;
        default:
          result = 'Unbekannte Aktion';
      }

      document.getElementById('actionResult').textContent = `${player ? player.name + ' → ' : ''}${result}`;
      logEvent(result);
      render();
    }

    function randomPlayer() {
      if (!state.players.length) return null;
      return state.players[Math.floor(Math.random() * state.players.length)];
    }

    function lootBonus(type) {
      const text = state.lootLog.join(' ');
      if (!text) return 0;
      let bonus = 0;
      if (type === 'hack' && text.match(/hack/i)) bonus += 8;
      if (type === 'scout' && text.match(/Scout/i)) bonus += 6;
      if (type === 'suppress' && text.match(/Unterdr/)) bonus += 4;
      if (state.morale >= 90) bonus += 4;
      return bonus;
    }

    function grantLoot(force) {
      let pool = lootTable;
      if (force) pool = lootTable.filter(l => ['Legendär', 'Episch', 'Selten'].includes(l.rarity));
      const loot = structuredClone(pool[Math.floor(Math.random() * pool.length)]);
      const entry = `${loot.rarity}: ${loot.name} (${loot.bonus})`;
      state.lootLog.push(entry);
      document.getElementById('lootBox').innerHTML = `<strong class="${loot.className}">${loot.rarity}</strong><br>${loot.name}<br><span class="muted small">${loot.bonus}</span>`;
      return entry;
    }

    function revealWeakness() {
      if (!state.threats.length) return 'keine Bedrohung aktiv';
      const target = state.threats[Math.floor(Math.random() * state.threats.length)];
      target.weakness = ['EMP', 'Schwachpunkt', 'Störsender', 'Koordiniertes Feuer'][Math.floor(Math.random() * 4)];
      return `${target.name}: ${target.weakness}`;
    }

    function hint() {
      if (state.pressure >= 6) return 'Druck hoch: Unterdrücken oder Hacken!';
      if (state.morale >= 100) return 'Hohe Moral: Loot-Boni aktiv.';
      if (state.supplies <= 1) return 'Supplies knapp: Versorgung sichern.';
      if (state.threats.length >= 3) return 'Zu viele Bedrohungen: Scouten & Neutralisieren.';
      return 'Bereit für den nächsten Push.';
    }

    function logEvent(text) {
      const timestamp = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
      const callouts = ['Echo meldet Arc-Funken', 'Radar: Spire-Ausschlag', 'HQ: Resist!'];
      const tag = callouts[Math.floor(Math.random() * callouts.length)];
      state.log.push(`[${timestamp}] ${text} (${tag})`);
    }

    function copyShareLink() {
      const payload = btoa(encodeURIComponent(JSON.stringify(state)));
      const url = `${location.origin}${location.pathname}#${payload}`;
      navigator.clipboard.writeText(url);
      logEvent('Session-Link kopiert.');
      render();
    }

    function loadFromLinkField() {
      const raw = document.getElementById('sessionLoad').value.trim();
      if (!raw) return;
      const hash = raw.includes('#') ? raw.split('#').pop() : raw;
      try {
        const parsed = JSON.parse(decodeURIComponent(atob(hash)));
        state = parsed;
        logEvent('Session geladen.');
        render();
        persist();
      } catch (e) {
        document.getElementById('actionResult').textContent = 'Konnte Session nicht laden.';
      }
    }

    function resetLocal() {
      state = baseState();
      logEvent('Lokaler Speicher gelöscht.');
      render();
      persist();
    }

    function toggleLanSync() {
      lanEndpoint = document.getElementById('lanEndpoint').value.trim() || `${location.origin}/api/session`;
      lanSyncEnabled = !lanSyncEnabled;
      lanToggleBtn.textContent = lanSyncEnabled ? 'LAN-Sync deaktivieren' : 'LAN-Sync aktivieren';
      if (lanSyncEnabled) {
        updateLanStatus('Verbunden (wartet auf Sync)');
        syncNow();
      } else {
        updateLanStatus('Offline – Browser-Only');
      }
    }

    function updateLanStatus(text) {
      lanStatus.textContent = text;
    }

    async function pushStateToServer() {
      try {
        const res = await fetch(`${lanEndpoint}/${state.sessionId}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ state }),
        });
        if (res.ok) {
          updateLanStatus('Gesendet – wartet auf Verbündete');
        } else {
          updateLanStatus('Fehler beim Senden');
        }
      } catch (err) {
        updateLanStatus('Server nicht erreichbar');
      }
    }

    async function pullStateFromServer() {
      try {
        const res = await fetch(`${lanEndpoint}/${state.sessionId}`);
        if (!res.ok) return;
        const data = await res.json();
        if (data.state && data.state.updatedAt > state.updatedAt) {
          state = data.state;
          render(true);
          updateLanStatus('Synchronisiert (LAN)');
        }
      } catch (err) {
        updateLanStatus('Server nicht erreichbar');
      }
    }

    function syncNow() {
      if (!lanSyncEnabled) return;
      pushStateToServer();
      pullStateFromServer();
    }

    setInterval(() => {
      if (lanSyncEnabled) pullStateFromServer();
    }, 5000);
  </script>
</body>
</html>
